<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan_SKBTHO2_Lengkap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-red: #ff0000; --dark-red: #b30000; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }

        .header-section {
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            color: white; padding: 30px 0; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
        }

        .action-bar { margin-top: 50px; margin-bottom: 30px; padding: 0 10px; }
        .card-table { border: none; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); background: white; }

        /* Maklumat Cetakan (Hanya muncul dalam PDF) */
        #printInfo { display: none; font-size: 0.75rem; color: #555; margin-bottom: 10px; text-align: right; }

        /* PENGATURAN KOLUM SKRIN */
        .table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .col-tarikh { width: 100px; }
        .col-nama { width: 200px; }
        .col-kelas { width: 80px; }
        .col-sebab { width: auto; }
        .col-pelapor { width: 180px; }
        .col-tindakan { width: 90px; }

        .table thead { background-color: var(--dark-red); color: white; }
        .table th { font-size: 0.75rem; text-transform: uppercase; padding: 12px 8px !important; text-align: center; border: none; }
        .table td { font-size: 0.85rem; vertical-align: middle; padding: 10px 8px !important; word-wrap: break-word; }
        
        .text-nama { font-weight: 700; color: #333; text-transform: uppercase; font-size: 0.8rem; }
        .text-kelas { color: var(--dark-red); font-weight: bold; text-align: center; }
        .text-pelapor { font-weight: 600; color: #555; text-transform: uppercase; font-size: 0.75rem; }
        .btn-padam { font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; }

        /* OPTIMASI CETAKAN A4 */
        @media print {
            @page { size: A4 portrait; margin: 1cm; }
            body { background: white !important; padding: 0; }
            .btn, .btn-padam, .col-tindakan, .action-bar { display: none !important; }
            #printInfo { display: block !important; }
            .header-section { background: none !important; color: black !important; border-bottom: 2px solid #000; border-radius: 0; padding: 10px 0; }
            .header-logo { width: 60px !important; filter: grayscale(1); }
            .table { border: 1px solid #000 !important; table-layout: fixed !important; width: 100% !important; }
            .table th, .table td { border: 1px solid #000 !important; color: black !important; padding: 8px !important; }
            
            /* Laraskan lebar kolum PDF (Jumlah 100%) */
            .col-tarikh { width: 12%; }
            .col-nama { width: 23%; }
            .col-kelas { width: 10%; }
            .col-sebab { width: 30%; }
            .col-pelapor { width: 25%; }
        }
    </style>
</head>
<body>

    <div class="header-section text-center">
        <div class="container">
            <img src="https://imgur.com/DLy3jZn.png" alt="Logo" style="width:70px;" class="mb-2 header-logo">
            <h1 style="font-weight:800; font-size:1.2rem;">SK BANDAR TUN HUSSEIN ONN 2</h1>
            <p class="mb-0 small opacity-75">Laporan Ketidakhadiran Aktiviti Kokurikulum</p>
        </div>
    </div>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center action-bar">
            <a href="index.html" class="btn btn-outline-danger btn-sm rounded-pill fw-bold">‚Üê BORANG</a>
            <button onclick="cetakLaporan()" class="btn btn-danger btn-sm rounded-pill fw-bold px-4 shadow">CETAK PDF (A4)</button>
        </div>

        <div id="printInfo"></div>

        <div class="card card-table overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="col-tarikh">Tarikh</th>
                            <th class="col-nama">Nama Murid</th>
                            <th class="col-kelas">Kelas</th>
                            <th class="col-sebab">Sebab</th>
                            <th class="col-pelapor">Pelapor (Guru)</th>
                            <th class="col-tindakan">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">Memuatkan data laporan...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Guna SCRIPT_URL terbaru anda
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwhBrT3lhsir-WdwAsK43l_xOoPMKNKXPqg0YESn1Wje6O25ODfhQcliiHBgUSgLKSQ/exec";

        async function muatData() {
            const tableBody = document.getElementById('tableBody');
            try {
                const response = await fetch(`${SCRIPT_URL}?t=${new Date().getTime()}`);
                const data = await response.json();
                
                if (!data || data.length <= 1) {
                    tableBody.innerHTML = "<tr><td colspan='6' class='text-center py-5'>Tiada rekod ditemui.</td></tr>";
                    return;
                }

                let html = "";
                // Loop dari data terbaru (paling bawah di Sheet)
                for (let i = data.length - 1; i >= 1; i--) {
                    const row = data[i];
                    
                    // Format Tarikh
                    let tarikhAsal = row[0] ? row[0].toString() : "";
                    let tarikhSahaja = tarikhAsal.split(' ')[0].split('T')[0]; 

                    html += `<tr>
                        <td class="text-center small">${tarikhSahaja}</td>
                        <td class="text-nama">${row[1] || '-'}</td>
                        <td class="text-kelas">${row[2] || '-'}</td>
                        <td class="small text-muted">${row[3] || '-'}</td>
                        <td class="text-pelapor">${row[4] || '-'}</td> <td class="text-center col-tindakan">
                            <button onclick="padamRekod(${i})" class="btn btn-light btn-padam text-danger border">Padam</button>
                        </td>
                    </tr>`;
                }
                tableBody.innerHTML = html;
            } catch (error) {
                tableBody.innerHTML = "<tr><td colspan='6' class='text-center py-5 text-danger'>Ralat sambungan. Sila muat semula halaman.</td></tr>";
            }
        }

        function cetakLaporan() {
            const sekarang = new Date();
            const tarikh = sekarang.toLocaleDateString('ms-MY');
            const masa = sekarang.toLocaleTimeString('ms-MY', { hour12: false });
            document.getElementById('printInfo').innerText = `Dicetak pada: ${tarikh} | Masa: ${masa}`;
            window.print();
        }

        async function padamRekod(index) {
            const pw = prompt("Masukkan Kata Laluan Padam:");
            if (pw === "4055") {
                if (confirm("Padam rekod ini secara kekal?")) {
                    try {
                        const res = await fetch(`${SCRIPT_URL}?del=${index}`);
                        const txt = await res.text();
                        if (txt.includes("Deleted")) { 
                            alert("Berjaya dipadam!"); 
                            muatData(); 
                        }
                    } catch (e) { alert("Ralat semasa memadam."); }
                }
            } else if (pw !== null) { alert("Kata laluan salah!"); }
        }

        muatData();
    </script>
</body>
</html>
